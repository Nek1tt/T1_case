<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Background Segmentation Studio Pro</title>
        <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-tflite@0.0.1-alpha.12/dist/tf-tflite.min.js"></script>

</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Background Segmentation Studio Pro</h1>
            <div class="fps-counter">
                <span class="fps-label">FPS:</span>
                <span class="fps-value">0</span>
            </div>
        </header>

        <div class="main-content">
            <div class="video-section">
                <div class="video-wrapper">
                    <video class="camera-feed" autoplay muted></video>
                    <div class="video-label">Camera Input</div>
                </div>

                <div class="canvas-wrapper">
                    <canvas class="output-canvas"></canvas>
                    <div class="video-label">Segmented Output</div>
                </div>
            </div>

            <div class="controls-panel">
                <h3>Background Settings</h3>
                
                <div class="control-group">
                    <label>Background Type:</label>
                    <div class="button-group">
                        <button class="bg-btn active" data-type="color">Color</button>
                        <button class="bg-btn" data-type="blur">Blur</button>
                        <button class="bg-btn" data-type="image">Image</button>
                        <button class="bg-btn" data-type="custom">Custom</button>
                    </div>
                </div>

                <div class="control-section" id="color-section">
                    <label>Select Color:</label>
                    <div class="color-palette">
                        <div class="color-option active" data-color="#667eea" style="background: #667eea;"></div>
                        <div class="color-option" data-color="#f093fb" style="background: #f093fb;"></div>
                        <div class="color-option" data-color="#4facfe" style="background: #4facfe;"></div>
                        <div class="color-option" data-color="#43e97b" style="background: #43e97b;"></div>
                        <div class="color-option" data-color="#fa709a" style="background: #fa709a;"></div>
                    </div>
                </div>

                <div class="control-section hidden" id="blur-section">
                    <label>Blur Amount: <span id="blur-value">10</span>px</label>
                    <input type="range" id="blur-slider" min="0" max="50" value="10" class="slider">
                </div>

                <div class="control-section hidden" id="image-section">
                    <label>Preset Images:</label>
                    <div class="image-presets">
                        <div class="preset-btn" data-image="office">
                            <div class="preset-icon">üè¢</div>
                            <span>Office</span>
                        </div>
                        <div class="preset-btn" data-image="library">
                            <div class="preset-icon">üìö</div>
                            <span>Library</span>
                        </div>
                        <div class="preset-btn" data-image="home">
                            <div class="preset-icon">üè†</div>
                            <span>Home</span>
                        </div>
                    </div>
                </div>

                <div class="control-section hidden" id="custom-section">
                    <label>Upload Custom Image:</label>
                    <input type="file" id="custom-upload" accept="image/*" class="file-input">
                    <div class="upload-info">JPG, PNG supported</div>
                </div>
            </div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-tflite/dist/tf-tflite.min.js"></script>

<script>
const video = document.querySelector('.camera-feed');
const canvas = document.querySelector('.output-canvas');
const ctx = canvas.getContext('2d');
const fpsValue = document.querySelector('.fps-value');

let tfliteModel = null;
let stream = null;
let lastTime = performance.now();
let frameCount = 0;
let fps = 0;

const MODEL_WIDTH = 224;
const MODEL_HEIGHT = 224;

// Background settings
let bgType = 'color';
let bgColor = '#667eea';
let blurAmount = 10;
let bgImage = null;

// ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–æ–π backend –¥–æ—Å—Ç—É–ø–µ–Ω: WebGPU ‚Üí WebGL ‚Üí CPU
async function selectBackend() {
    try {
        if (await tf.setBackend('webgpu')) {
            console.log('‚úÖ Using WebGPU backend');
        }
    } catch (e) {
        try {
            await tf.setBackend('webgl');
            console.log('‚úÖ Using WebGL backend');
        } catch (e2) {
            await tf.setBackend('cpu');
            console.log('‚öôÔ∏è Using CPU backend');
        }
    }
    await tf.ready();
}

// ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ–º TFLite –º–æ–¥–µ–ª—å —Å –≤—ã–±–æ—Ä–æ–º –¥–µ–ª–µ–≥–∞—Ç–∞ GPU, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
async function loadTFLiteModel() {
    try {
        console.log('Loading TFLite model...');
        
        if (typeof tflite === 'undefined') {
            console.error('TFLite library not loaded properly!');
            return false;
        }

        // ‚úÖ –í –±—Ä–∞—É–∑–µ—Ä–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º XNNPACK (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π CPU –¥–µ–ª–µ–≥–∞—Ç)
        const options = {
            delegates: ['xnnpack'] // –ë—ã—Å—Ç—Ä–µ–µ –æ–±—ã—á–Ω–æ–≥–æ CPU
        };
        
        console.log('Using TFLite delegate: XNNPACK (optimized)');
        
        tfliteModel = await tflite.loadTFLiteModel(
            'segmentation_model3.tflite', 
            options
        );
        
        console.log('TFLite model loaded successfully');
        return true;
    } catch (err) {
        console.error('Failed to load TFLite model:', err);
        
        // Fallback –Ω–∞ –æ–±—ã—á–Ω—ã–π CPU –µ—Å–ª–∏ XNNPACK –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
        try {
            console.log('Trying CPU delegate as fallback...');
            tfliteModel = await tflite.loadTFLiteModel(
                'segmentation_model3.tflite'
            );
            return true;
        } catch (fallbackErr) {
            console.error('CPU fallback also failed:', fallbackErr);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å TFLite –º–æ–¥–µ–ª—å.');
            return false;
        }
    }
}

async function initCamera() {
    try {
        stream = await navigator.mediaDevices.getUserMedia({
            video: {
                width: { ideal: 1280 },
                height: { ideal: 720 },
                facingMode: 'user'
            },
            audio: false
        });
        video.srcObject = stream;
        await new Promise(resolve => video.onloadedmetadata = resolve);
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        console.log(`Camera ready: ${video.videoWidth}x${video.videoHeight}`);
    } catch (err) {
        console.error('Camera access error:', err);
        alert('Camera access denied or unavailable');
    }
}

function preprocess(video) {
    return tf.tidy(() => {
        let img = tf.browser.fromPixels(video).toFloat();
        img = tf.image.resizeBilinear(img, [MODEL_HEIGHT, MODEL_WIDTH]);
        img = img.div(255.0).expandDims(0);
        return img;
    });
}

async function runSegmentation(video) {
    if (!tfliteModel) return null;

    try {
        const input = preprocess(video);
        const output = await tfliteModel.predict(input);
        input.dispose();

        const data = await output.data();
        output.dispose();
        return data;
    } catch (err) {
        console.error('Segmentation error:', err);
        return null;
    }
}

function createMask(outputData, width, height) {
    const maskCanvas = document.createElement('canvas');
    maskCanvas.width = width;
    maskCanvas.height = height;
    const maskCtx = maskCanvas.getContext('2d');
    const imgData = maskCtx.createImageData(width, height);
    const pixels = imgData.data;

    for (let i = 0; i < width * height; i++) {
        const val = outputData[i] > 0.5 ? 255 : 0;
        pixels[i * 4 + 0] = 255;
        pixels[i * 4 + 1] = 255;
        pixels[i * 4 + 2] = 255;
        pixels[i * 4 + 3] = val;
    }

    maskCtx.putImageData(imgData, 0, 0);
    return maskCanvas;
}

function drawBackground() {
    if (bgType === 'color') {
        ctx.fillStyle = bgColor;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    } else if (bgType === 'blur') {
        ctx.filter = `blur(${blurAmount}px)`;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        ctx.filter = 'none';
    } else if (bgType === 'image' || bgType === 'custom') {
        if (bgImage) {
            ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);
        } else {
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
    }
}

async function renderFrame() {
    const currentTime = performance.now();
    frameCount++;

    if (currentTime - lastTime >= 1000) {
        fps = Math.round(frameCount / ((currentTime - lastTime) / 1000));
        fpsValue.textContent = fps;
        frameCount = 0;
        lastTime = currentTime;
    }

    if (video.readyState === video.HAVE_ENOUGH_DATA) {
        const maskData = await runSegmentation(video);

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawBackground();

        if (maskData) {
            const maskCanvas = createMask(maskData, MODEL_WIDTH, MODEL_HEIGHT);
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');

            tempCtx.drawImage(video, 0, 0, canvas.width, canvas.height);
            tempCtx.globalCompositeOperation = 'destination-in';
            tempCtx.drawImage(maskCanvas, 0, 0, canvas.width, canvas.height);

            ctx.drawImage(tempCanvas, 0, 0);
        } else {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        }
    }

    requestAnimationFrame(renderFrame);
}

async function init() {
    await selectBackend();  // ‚úÖ –í—ã–±–∏—Ä–∞–µ–º –ª—É—á—à–∏–π –¥–æ—Å—Ç—É–ø–Ω—ã–π backend
    const loaded = await loadTFLiteModel();
    if (loaded) {
        await initCamera();
        renderFrame();
    }
}
// UI Event Handlers
document.querySelectorAll('.bg-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        document.querySelectorAll('.bg-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        bgType = btn.dataset.type;
        
        document.querySelectorAll('.control-section').forEach(s => s.classList.add('hidden'));
        const sectionId = `${bgType}-section`;
        const section = document.getElementById(sectionId);
        if (section) section.classList.remove('hidden');
    });
});

document.querySelectorAll('.color-option').forEach(option => {
    option.addEventListener('click', () => {
        document.querySelectorAll('.color-option').forEach(o => o.classList.remove('active'));
        option.classList.add('active');
        bgColor = option.dataset.color;
    });
});

document.getElementById('blur-slider').addEventListener('input', (e) => {
    blurAmount = parseInt(e.target.value);
    document.getElementById('blur-value').textContent = blurAmount;
});

document.querySelectorAll('.preset-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        const imageType = btn.dataset.image;
        const img = new Image();
        img.onload = () => { bgImage = img; };
        
        const presets = {
            'office': 'https://images.unsplash.com/photo-1497366216548-37526070297c?w=1200&h=800&fit=crop',
            'library': 'https://images.unsplash.com/photo-1507842217343-583bb7270b66?w=1200&h=800&fit=crop',
            'home': 'https://images.unsplash.com/photo-1556912172-45b7abe8b7e1?w=1200&h=800&fit=crop'
        };
        
        img.src = presets[imageType];
    });
});

document.getElementById('custom-upload').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
            const img = new Image();
            img.onload = () => { bgImage = img; };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    }
});

// ‚úÖ –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ DOM
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
} else {
    init();
}
</script>


<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
    background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
    padding: 20px;
    min-height: 100vh;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
}

.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    padding: 16px 24px;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    margin-bottom: 24px;
}

.header h1 {
    font-size: 24px;
    color: #2d3748;
}

.fps-counter {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 8px 16px;
    border-radius: 8px;
    color: white;
    font-weight: bold;
}

.main-content {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 20px;
}

.video-section {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.video-wrapper,
.canvas-wrapper {
    background: white;
    padding: 10px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    position: relative;
}

.camera-feed,
.output-canvas {
    width: 100%;
    border-radius: 12px;
    display: block;
}

.video-label {
    position: absolute;
    top: 16px;
    left: 16px;
    background: rgba(0,0,0,0.6);
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
}

.controls-panel {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

.controls-panel h3 {
    color: #2d3748;
    margin-bottom: 20px;
    font-size: 18px;
}

.control-group {
    margin-bottom: 24px;
}

.control-group label {
    display: block;
    color: #4a5568;
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 10px;
}

.button-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
}

.bg-btn {
    padding: 10px;
    border: 2px solid #e2e8f0;
    background: white;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    color: #4a5568;
    transition: all 0.2s;
}

.bg-btn:hover {
    border-color: #667eea;
    color: #667eea;
}

.bg-btn.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-color: transparent;
    color: white;
}

.control-section {
    margin-bottom: 20px;
    padding-top: 12px;
}

.control-section.hidden {
    display: none;
}

.control-section label {
    display: block;
    color: #4a5568;
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 12px;
}

.color-palette {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 10px;
}

.color-option {
    width: 100%;
    aspect-ratio: 1;
    border-radius: 8px;
    cursor: pointer;
    border: 3px solid transparent;
    transition: all 0.2s;
}

.color-option:hover {
    transform: scale(1.1);
}

.color-option.active {
    border-color: #2d3748;
    transform: scale(1.15);
}

.slider {
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: #e2e8f0;
    outline: none;
    -webkit-appearance: none;
}

.slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    cursor: pointer;
}

.slider::-moz-range-thumb {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    cursor: pointer;
    border: none;
}

.image-presets {
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px;
}

.preset-btn {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    background: white;
}

.preset-btn:hover {
    border-color: #667eea;
    background: #f7fafc;
}

.preset-btn.active {
    border-color: #667eea;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
}

.preset-icon {
    font-size: 24px;
}

.preset-btn span {
    font-weight: 600;
    color: #4a5568;
}

.file-input {
    width: 100%;
    padding: 10px;
    border: 2px dashed #cbd5e0;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    color: #4a5568;
}

.file-input:hover {
    border-color: #667eea;
}

.upload-info {
    margin-top: 8px;
    font-size: 12px;
    color: #718096;
}

@media (max-width: 1200px) {
    .main-content {
        grid-template-columns: 1fr;
    }
    
    .video-section {
        grid-template-columns: 1fr;
    }
}
</style>
</body>
</html>